# Diário de Implementações - 2026-02-14

## Problema Reportado pelo Usuário
O painel do robô não estava funcionando corretamente:
- Valor alocado menor que os valores das operações em andamento
- Simulações irreais
- Nunca apresentava lucros e perdas (P&L sempre mostrava "Calculando...")
- Mais de 15 horas tentando fazer simulações baseadas em dados reais da Binance sem sucesso
- Posições duplicadas aparecendo no painel

---

## Análise Realizada

### 1. Problema de P&L Não Calculado
**Causa Raiz:** O código não buscava o preço atual da Binance para calcular o P&L em tempo real. As posições abertas mostravam sempre "Calculando..." porque o `profit_loss` só era definido quando a posição era fechada.

### 2. Problema de Posições Duplicadas
**Causa Raiz:** O sistema não verificava corretamente se já existia uma posição aberta para o mesmo símbolo antes de abrir uma nova. Isso resultava em múltiplas posições do mesmo par (ex: 5+ posições de ESPUSDT).

### 3. Problema de Capital Alocado
**Causa Raiz:** O sistema não verificava se havia capital disponível antes de abrir novas posições, permitindo que o capital alocado excedesse o saldo virtual.

### 4. Dados de Mercado Irreais
**Causa Raiz:** A API da Binance estava retornando 451 (bloqueio regional) nos mirrors diretos. O sistema usa proxy Vercel como fallback.

---

## Correções Implementadas

### Arquivo: `src/services/statsService.ts`

1. **Cálculo de P&L em Tempo Real**
   - Adicionado import do `binanceService`
   - Criada nova lógica para buscar preço atual de cada posição aberta
   - Calculado P&L não realizado (unrealizedPnL) baseado no preço atual
   - O saldo atual agora inclui P&L não realizado

2. **Detecção Correta de Posições Abertas**
   - Modificada lógica para identificar posições que ainda não foram vendidas
   - Considera agora vendas correspondentes para determinar se posição está aberta

3. **Novos Campos no Interface AccountStats**
   - `unrealizedPnL`: P&L total não realizado
   - `activeTrades`: Agora inclui `currentPrice`, `unrealizedPnL`, `unrealizedPnLPercent`

### Arquivo: `src/services/tradingService.ts`

1. **Prevenção de Posições Duplicadas**
   - Adicionada verificação robusta por símbolo (não por tradeId)
   - Verifica se já existe posição aberta antes de comprar

2. **Verificação de Capital Disponível**
   - Calculado capital já alocado em posições abertas
   - Verifica se há capital suficiente antes de abrir nova posição
   - Log de advertência quando capital é insuficiente

### Arquivo: `src/services/localDbService.ts`

1. **Método de Limpeza de Posições Duplicadas**
   - Novo método `cleanDuplicatePositions()`
   - Remove posições duplicadas do banco de dados local
   - Mantém apenas a posição mais antiga para cada símbolo

### Arquivo: `src/components/Dashboard.tsx`

1. **Exibição de P&L em Tempo Real**
   - Atualizado para exibir preço atual da posição
   - Exibe P&L percentual com cores (verde=lucro, vermelho=perda)
   - Atualização automática a cada 30 segundos

2. **Botão de Limpeza de Emergência**
   - Adicionado botão "Limpar Duplicadas" no painel
   - Chama o método `localDb.cleanDuplicatePositions()`
   - Feedback visual com toast de sucesso/erro

---

## Configurações do Robô (Risk Service)

**riskService.ts - Parâmetros Atuais:**
- STOP_LOSS_PERCENT: 1.0%
- TAKE_PROFIT_PERCENT: 1.5%
- MAX_HOLD_MINUTES: 15 min
- CAPITAL_PER_ROUND_PERCENT: 10%
- MAX_ALLOCATION_PER_PAIR_PERCENT: 5%
- MAX_POSITIONS: 3 posições simultâneas
- PAIR_COOLDOWN_SECONDS: 300s (5 min)

---

## Como Testar as Correções

1. **Limpar Posições Duplicadas:**
   - Acesse o Dashboard
   - Clique no botão "Limpar Duplicadas"
   - Verifique se o número de posições ativas diminuiu

2. **Verificar P&L em Tempo Real:**
   - Abra uma posição de compra
   - Aguarde alguns segundos
   - O P&L deve mostrar valor percentual (ex: +0.25% ou -0.15%)

3. **Verificar Capital:**
   - O valor "Alocação Real (Em Trade)" não deve ultrapassar o saldo virtual

---

## Problemas Ainda Pendentes

1. **API Binance 451:** A Binance está bloqueando requisições da VPS (retornando 451). O sistema tenta usar mirrors alternativos e proxy Vercel.

2. **Falhas Frequentes do Bot:** O bot está morrendo frequentemente mas o Guardian (watchdog) está reiniciando automaticamente.

---

## Commit Realizado

```
commit f480c54
fix: Corrigir P&L em tempo real, posições duplicadas e alocação de capital

4 files changed, 225 insertions(+), 19 deletions(-)
```

**Repositório:** https://github.com/paralela17-sudo/volatile-trader-app.git

---

## Próximos Passos Sugeridos

1. Testar as correções em modo simulação
2. Verificar se Vercel fez o deploy automaticamente
3. Monitorar se as posições duplicadas param de aparecer
4. Ajustar parâmetros de risco se necessário
5. Testar com dados reais após validar em modo teste
